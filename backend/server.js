import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import compression from 'compression';
import dotenv from 'dotenv';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

const app = express();
const PORT = process.env.PORT || 10000;

// Middleware
app.use(helmet());
app.use(compression());
app.use(cors({
  origin: [
    'http://localhost:3000',
    'https://web.telegram.org',
    'https://d-gnome-horoscope-miniapp-frontend.vercel.app',
    process.env.FRONTEND_URL
  ].filter(Boolean),
  methods: ['GET', 'POST', 'OPTIONS'],
  credentials: true
}));

app.use(express.json({ limit: '10mb' }));
app.options('*', cors());

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  next();
});

// –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç –¥–Ω—è
const dayCards = [
  { title: '–ú–æ–ª–æ—Ç –¢–≤–æ—Ä—Ü–∞', text: '–°–µ–≥–æ–¥–Ω—è –≤—ã –æ–±–ª–∞–¥–∞–µ—Ç–µ —Å–∏–ª–æ–π —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –∏–∑–º–µ–Ω—è—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —ç–Ω–µ—Ä–≥–∏—é –º—É–¥—Ä–æ –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –¥–µ–ª!' },
  { title: '–ö—Ä–∏—Å—Ç–∞–ª–ª –ú—É–¥—Ä–æ—Å—Ç–∏', text: '–Ø—Å–Ω–æ—Å—Ç—å –º—ã—Å–ª–∏ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ –ª—é–±–æ–π –∑–∞–¥–∞—á–∏. –î–æ–≤–µ—Ä—å—Ç–µ—Å—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –º—É–¥—Ä–æ—Å—Ç–∏ –≥–Ω–æ–º–æ–≤.' },
  { title: '–©–∏—Ç –ó–∞—â–∏—Ç—ã', text: '–í—ã –ø–æ–¥ –Ω–∞–¥–µ–∂–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –¥—Ä–µ–≤–Ω–∏—Ö –¥—É—Ö–æ–≤. –°–º–µ–ª–æ –∏–¥–∏—Ç–µ –≤–ø–µ—Ä–µ–¥, –Ω–µ –±–æ—è—Å—å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π.' },
  { title: '–ó–µ–ª—å–µ –£–¥–∞—á–∏', text: '–§–æ—Ä—Ç—É–Ω–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–∞–≥–æ—Å–∫–ª–æ–Ω–Ω–∞ –∫ –≤–∞–º! –û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π –∏ —Å–º–µ–ª—ã—Ö —Ä–µ—à–µ–Ω–∏–π.' },
  { title: '–ö–ª—é—á –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π', text: '–ü–µ—Ä–µ–¥ –≤–∞–º–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ –¥–≤–µ—Ä–∏. –ë—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ã –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –ø–µ—Ä–µ–º–µ–Ω–∞–º –∫ –ª—É—á—à–µ–º—É.' },
  { title: '–ê–º—É–ª–µ—Ç –°–∏–ª—ã', text: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏–ª–∞ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å –ª—é–±—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏. –í—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –¥—É–º–∞–µ—Ç–µ!' },
  { title: '–ö–æ–º–ø–∞—Å –°—É–¥—å–±—ã', text: '–ü—É—Ç—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è—Å–Ω–µ–µ. –î–æ–≤–µ—Ä—å—Ç–µ—Å—å –∏–Ω—Ç—É–∏—Ü–∏–∏ - –æ–Ω–∞ –ø—Ä–∏–≤–µ–¥–µ—Ç –≤–∞—Å –∫ —Ü–µ–ª–∏.' },
  { title: '–ß–∞—à–∞ –ò–∑–æ–±–∏–ª–∏—è', text: '–ò–∑–æ–±–∏–ª–∏–µ –≤–æ –≤—Å–µ—Ö —Å—Ñ–µ—Ä–∞—Ö –∂–∏–∑–Ω–∏. –©–µ–¥—Ä–æ –¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –¥–∞—Ä–∞–º–∏ —Å –æ–∫—Ä—É–∂–∞—é—â–∏–º–∏.' }
];

const adviceTexts = [
  '–ü–æ–º–Ω–∏—Ç–µ: –∫–∞–∂–¥—ã–π –≤–µ–ª–∏–∫–∏–π –≥–Ω–æ–º –Ω–∞—á–∏–Ω–∞–ª —Å –º–∞–ª–æ–≥–æ. –í–µ–ª–∏–∫–∏–µ –¥–µ–ª–∞ —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –∏–∑ –º–∞–ª–µ–Ω—å–∫–∏—Ö —à–∞–≥–æ–≤.',
  '–ú—É–¥—Ä—ã–π –≥–Ω–æ–º –∑–Ω–∞–µ—Ç: –ª—É—á—à–µ –æ–¥–∏–Ω —Ä–∞–∑ —É–≤–∏–¥–µ—Ç—å, —á–µ–º —Å—Ç–æ —Ä–∞–∑ —É—Å–ª—ã—à–∞—Ç—å. –î–µ–π—Å—Ç–≤—É–π—Ç–µ!',
  '–í –∫—É–∑–Ω–∏—Ü–µ –∂–∏–∑–Ω–∏ –∫–∞–∂–¥—ã–π —É–¥–∞—Ä –º–æ–ª–æ—Ç–∞ –≤–∞–∂–µ–Ω. –ù–µ –ø—Ä–µ–Ω–µ–±—Ä–µ–≥–∞–π—Ç–µ –º–µ–ª–æ—á–∞–º–∏ - –æ–Ω–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –±—É–¥—É—â–µ–µ.',
  '–ó–æ–ª–æ—Ç–æ –Ω–µ —Ä–∂–∞–≤–µ–µ—Ç, –∞ –¥–æ–±—Ä–æ—Ç–∞ –Ω–µ —Å—Ç–∞—Ä–µ–µ—Ç. –ë—É–¥—å—Ç–µ –¥–æ–±—Ä—ã–º–∏ –∫ –æ–∫—Ä—É–∂–∞—é—â–∏–º - —ç—Ç–æ –ª—É—á—à–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è.',
  '–¢–µ—Ä–ø–µ–Ω–∏–µ –≥–Ω–æ–º–∞ –≥–ª—É–±–∂–µ —Å–∞–º–æ–π –≥–ª—É–±–æ–∫–æ–π —à–∞—Ö—Ç—ã. –£–º–µ–π—Ç–µ –∂–¥–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞.',
  '–î–∞–∂–µ —Å–∞–º—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π –≥–Ω–æ–º –º–æ–∂–µ—Ç —Å–¥–≤–∏–Ω—É—Ç—å –≥–æ—Ä—É, –µ—Å–ª–∏ –∑–Ω–∞–µ—Ç —Ç–æ—á–∫—É –æ–ø–æ—Ä—ã. –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ—é —Å–∏–ª—É.',
  '–î—Ä—É–∂–±–∞ –¥–æ—Ä–æ–∂–µ –ª—é–±–æ–≥–æ —Å–∞–º–æ—Ü–≤–µ—Ç–∞ –≤ —Å–æ–∫—Ä–æ–≤–∏—â–Ω–∏—Ü–µ. –ë–µ—Ä–µ–≥–∏—Ç–µ —Ç–µ—Ö, –∫—Ç–æ —Ä—è–¥–æ–º —Å –≤–∞–º–∏.',
  '–°–º–µ—Ö –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –∂–∏–∑–Ω—å –≥–Ω–æ–º–∞ –Ω–∞ —Å—Ç–æ –ª–µ—Ç. –ù–∞—Ö–æ–¥–∏—Ç–µ —Ä–∞–¥–æ—Å—Ç—å –≤ –ø—Ä–æ—Å—Ç—ã—Ö –≤–µ—â–∞—Ö.',
  '–ß–µ—Å—Ç–Ω–æ—Å—Ç—å - –ª—É—á—à–∞—è –∫–∏—Ä–∫–∞ –¥–ª—è –¥–æ–±—ã—á–∏ –∏—Å—Ç–∏–Ω—ã. –ë—É–¥—å—Ç–µ –∏—Å–∫—Ä–µ–Ω–Ω–∏–º–∏ —Å —Å–æ–±–æ–π –∏ –¥—Ä—É–≥–∏–º–∏.',
  '–ú—É–¥—Ä–æ—Å—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–µ —Å –≥–æ–¥–∞–º–∏, –∞ —Å –æ–ø—ã—Ç–æ–º. –£—á–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–µ –∏ –ø–æ–±–µ–¥–µ.'
];

// –õ—É–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
const moonPhases = [
  { phase: '–ù–æ–≤–æ–ª—É–Ω–∏–µ', emoji: 'üåë', illumination: 2 },
  { phase: '–ú–æ–ª–æ–¥–∞—è –ª—É–Ω–∞', emoji: 'üåí', illumination: 15 },
  { phase: '–ü–µ—Ä–≤–∞—è —á–µ—Ç–≤–µ—Ä—Ç—å', emoji: 'üåì', illumination: 50 },
  { phase: '–†–∞—Å—Ç—É—â–∞—è –ª—É–Ω–∞', emoji: 'üåî', illumination: 75 },
  { phase: '–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ', emoji: 'üåï', illumination: 98 },
  { phase: '–£–±—ã–≤–∞—é—â–∞—è –ª—É–Ω–∞', emoji: 'üåñ', illumination: 75 },
  { phase: '–ü–æ—Å–ª–µ–¥–Ω—è—è —á–µ—Ç–≤–µ—Ä—Ç—å', emoji: 'üåó', illumination: 50 },
  { phase: '–°—Ç–∞—Ä–∞—è –ª—É–Ω–∞', emoji: 'üåò', illumination: 15 }
];

// –£—Ç–∏–ª–∏—Ç—ã
function getRandomItem(array) {
  return array[Math.floor(Math.random() * array.length)];
}

function calculateLifeNumber(birthDate) {
  const digits = birthDate.replace(/-/g, '').split('').map(Number);
  let sum = digits.reduce((a, b) => a + b, 0);
  while (sum > 9) {
    sum = sum.toString().split('').map(Number).reduce((a, b) => a + b, 0);
  }
  return sum;
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –°–£–ü–ï–† –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
function generateActualHoroscope(sign) {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const dayOfMonth = now.getDate();
  const month = now.getMonth();
  const hour = now.getHours();
  const minutes = now.getMinutes();
  
  // –†–µ–∞–ª—å–Ω—ã–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã –Ω–∞ –°–ï–ì–û–î–ù–Ø (26 –∞–≤–≥—É—Å—Ç–∞ 2025)
  const todayFactors = {
    // –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∏—Ç—ã –ø–ª–∞–Ω–µ—Ç
    mercury_direct: true, // –ú–µ—Ä–∫—É—Ä–∏–π –¥–∏—Ä–µ–∫—Ç–Ω—ã–π —Å 11 –∞–≤–≥—É—Å—Ç–∞
    sun_in_virgo: month === 7 && dayOfMonth >= 22, // –°–æ–ª–Ω—Ü–µ –≤ –î–µ–≤–µ —Å 22 –∞–≤–≥—É—Å—Ç–∞
    venus_in_libra: month === 7 && dayOfMonth >= 20, // –í–µ–Ω–µ—Ä–∞ –≤ –í–µ—Å–∞—Ö 
    mars_in_cancer: month === 7, // –ú–∞—Ä—Å –≤ –†–∞–∫–µ –≤–µ—Å—å –∞–≤–≥—É—Å—Ç
    jupiter_in_gemini: true, // –Æ–ø–∏—Ç–µ—Ä –≤ –ë–ª–∏–∑–Ω–µ—Ü–∞—Ö –≤–µ—Å—å 2025
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∞–≤–≥—É—Å—Ç–∞ 2025
    perseid_aftermath: dayOfMonth >= 12 && dayOfMonth <= 20, // –ü–æ—Å–ª–µ –ü–µ—Ä—Å–µ–∏–¥
    leo_season_ending: dayOfMonth <= 22, // –ö–æ–Ω–µ—Ü —Å–µ–∑–æ–Ω–∞ –õ—å–≤–∞
    virgo_season_start: dayOfMonth >= 23, // –ù–∞—á–∞–ª–æ —Å–µ–∑–æ–Ω–∞ –î–µ–≤—ã
    waning_moon: dayOfMonth >= 9 && dayOfMonth <= 23, // –£–±—ã–≤–∞—é—â–∞—è –ª—É–Ω–∞
    
    // –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (26 –∞–≤–≥—É—Å—Ç–∞)
    moon_mars_conjunction: dayOfMonth === 26, // –õ—É–Ω–∞ —Ä—è–¥–æ–º —Å –ú–∞—Ä—Å–æ–º –°–ï–ì–û–î–ù–Ø!
    
    // –í—Ä–µ–º—è —Å—É—Ç–æ–∫
    is_morning: hour >= 6 && hour < 12,
    is_afternoon: hour >= 12 && hour < 18,
    is_evening: hour >= 18 && hour < 24,
    is_night: hour >= 0 && hour < 6,
    
    // –≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞ –¥–Ω—è
    high_energy_time: hour >= 10 && hour <= 14,
    reflection_time: hour >= 20 || hour <= 6,
    social_time: hour >= 16 && hour <= 22
  };

  // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∑–Ω–∞–∫–æ–≤ —Å –ø–ª–∞–Ω–µ—Ç–∞–º–∏-—É–ø—Ä–∞–≤–∏—Ç–µ–ª—è–º–∏
  const signData = {
    '–û–≤–µ–Ω': { 
      element: 'fire', 
      ruler: 'mars', 
      traits: ['—ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π', '–∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–Ω—ã–π', '—Å—Ç—Ä–∞—Å—Ç–Ω—ã–π'],
      strengths: ['–ª–∏–¥–µ—Ä—Å—Ç–≤–æ', '—Å–º–µ–ª–æ—Å—Ç—å', '–±—ã—Å—Ç—Ä–æ—Ç–∞ —Ä–µ—à–µ–Ω–∏–π'],
      challenges: ['–∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å', '–Ω–µ—Ç–µ—Ä–ø–µ–ª–∏–≤–æ—Å—Ç—å']
    },
    '–¢–µ–ª–µ—Ü': { 
      element: 'earth', 
      ruler: 'venus', 
      traits: ['—Å—Ç–∞–±–∏–ª—å–Ω—ã–π', '—á—É–≤—Å—Ç–≤–µ–Ω–Ω—ã–π', '—É–ø–æ—Ä–Ω—ã–π'],
      strengths: ['–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å', '–ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å', '—ç—Å—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –≤–∫—É—Å'],
      challenges: ['—É–ø—Ä—è–º—Å—Ç–≤–æ', '–º–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å']
    },
    '–ë–ª–∏–∑–Ω–µ—Ü—ã': { 
      element: 'air', 
      ruler: 'mercury', 
      traits: ['–ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π', '–≥–∏–±–∫–∏–π', '–∫–æ–º–º—É–Ω–∏–∫–∞–±–µ–ª—å–Ω—ã–π'],
      strengths: ['–∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å', '–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç', '–º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å'],
      challenges: ['–Ω–µ–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ', '–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ—Å—Ç—å']
    },
    '–†–∞–∫': { 
      element: 'water', 
      ruler: 'moon', 
      traits: ['—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π', '–∑–∞–±–æ—Ç–ª–∏–≤—ã–π', '–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π'],
      strengths: ['—ç–º–ø–∞—Ç–∏—è', '–∑–∞—â–∏—Ç–∞ –±–ª–∏–∑–∫–∏—Ö', '–ø–∞–º—è—Ç—å'],
      challenges: ['–ø–µ—Ä–µ–ø–∞–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è', '–æ–±–∏–¥—á–∏–≤–æ—Å—Ç—å']
    },
    '–õ–µ–≤': { 
      element: 'fire', 
      ruler: 'sun', 
      traits: ['—Ç–≤–æ—Ä—á–µ—Å–∫–∏–π', '—â–µ–¥—Ä—ã–π', '–¥—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π'],
      strengths: ['—Ö–∞—Ä–∏–∑–º–∞', '–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å', '–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ'],
      challenges: ['—ç–≥–æ–∏–∑–º', '–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø—Ä–∏–∑–Ω–∞–Ω–∏–∏']
    },
    '–î–µ–≤–∞': { 
      element: 'earth', 
      ruler: 'mercury', 
      traits: ['–∞–Ω–∞–ª–∏—Ç–∏—á–Ω—ã–π', '–ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç', '–ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π'],
      strengths: ['–≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª—è–º', '–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ—Å—Ç—å', '—Å–ª—É–∂–µ–Ω–∏–µ'],
      challenges: ['–∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å', '—Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å']
    },
    '–í–µ—Å—ã': { 
      element: 'air', 
      ruler: 'venus', 
      traits: ['–≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π', '–¥–∏–ø–ª–æ–º–∞—Ç–∏—á–Ω—ã–π', '—ç—Å—Ç–µ—Ç–∏—á–Ω—ã–π'],
      strengths: ['—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å', '–ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ', '–∫—Ä–∞—Å–æ—Ç–∞'],
      challenges: ['–Ω–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –¥—Ä—É–≥–∏—Ö']
    },
    '–°–∫–æ—Ä–ø–∏–æ–Ω': { 
      element: 'water', 
      ruler: 'pluto', 
      traits: ['–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π', '—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—â–∏–π', '–º–∞–≥–Ω–µ—Ç–∏—á–Ω—ã–π'],
      strengths: ['–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è', '–≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ', '–≥–ª—É–±–∏–Ω–∞'],
      challenges: ['—Ä–µ–≤–Ω–æ—Å—Ç—å', '–º—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å']
    },
    '–°—Ç—Ä–µ–ª–µ—Ü': { 
      element: 'fire', 
      ruler: 'jupiter', 
      traits: ['—Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π', '–∞–≤–∞–Ω—Ç—é—Ä–Ω—ã–π', '–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π'],
      strengths: ['–º—É–¥—Ä–æ—Å—Ç—å', '–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', '—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–æ–≤'],
      challenges: ['–±–µ–∑–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', '–ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ—Å—Ç—å']
    },
    '–ö–æ–∑–µ—Ä–æ–≥': { 
      element: 'earth', 
      ruler: 'saturn', 
      traits: ['–∞–º–±–∏—Ü–∏–æ–∑–Ω—ã–π', '–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π', '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'],
      strengths: ['–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è', '—Å—Ç—Ä—É–∫—Ç—É—Ä–∞', '–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç'],
      challenges: ['–ø–µ—Å—Å–∏–º–∏–∑–º', '–∂—ë—Å—Ç–∫–æ—Å—Ç—å']
    },
    '–í–æ–¥–æ–ª–µ–π': { 
      element: 'air', 
      ruler: 'uranus', 
      traits: ['–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π', '–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π', '–≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–π'],
      strengths: ['–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å', '—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', '–¥—Ä—É–∂–±–∞'],
      challenges: ['–æ—Ç—á—É–∂–¥—ë–Ω–Ω–æ—Å—Ç—å', '—É–ø—Ä—è–º—Å—Ç–≤–æ –≤ –∏–¥–µ—è—Ö']
    },
    '–†—ã–±—ã': { 
      element: 'water', 
      ruler: 'neptune', 
      traits: ['–º–µ—á—Ç–∞—Ç–µ–ª—å–Ω—ã–π', '—Å–æ—Å—Ç—Ä–∞–¥–∞—Ç–µ–ª—å–Ω—ã–π', '–∞—Ä—Ç–∏—Å—Ç–∏—á–Ω—ã–π'],
      strengths: ['–∏–Ω—Ç—É–∏—Ü–∏—è', '–¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å', '—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ'],
      challenges: ['—ç—Å–∫–∞–ø–∏–∑–º', '–∂–µ—Ä—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å']
    }
  };

  const currentSign = signData[sign];
  let horoscope = `–ì–Ω–æ–º ${getGnomeName(sign)} `;

  // === –ê–ö–¢–£–ê–õ–¨–ù–´–ï –°–û–ë–´–¢–ò–Ø –°–ï–ì–û–î–ù–Ø (26 –∞–≤–≥—É—Å—Ç–∞) ===
  if (todayFactors.moon_mars_conjunction) {
    horoscope += `–≤–∏–¥–∏—Ç –æ—Å–æ–±–æ–µ —Å–±–ª–∏–∂–µ–Ω–∏–µ –õ—É–Ω—ã –∏ –ú–∞—Ä—Å–∞ –ø—Ä—è–º–æ –°–ï–ì–û–î–ù–Ø –≤–µ—á–µ—Ä–æ–º! `;
    
    if (currentSign.element === 'water' || currentSign.ruler === 'moon') {
      horoscope += `–≠—Ç–æ –º–æ—â–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ —ç–º–æ—Ü–∏–∏ –∏ –∏–Ω—Ç—É–∏—Ü–∏—é. –ß—É–≤—Å—Ç–≤–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ —è—Ä–∫–∏–º–∏. `;
    } else if (currentSign.element === 'fire' || currentSign.ruler === 'mars') {
      horoscope += `–ú–∞—Ä—Å —Ä—è–¥–æ–º —Å –õ—É–Ω–æ–π –∑–∞–∂–∏–≥–∞–µ—Ç –≤–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ–≥–æ–Ω—å! –û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Å–º–µ–ª—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∏ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Å—Ç–∏. `;
    } else {
      horoscope += `–≠—Ç–æ —Ä–µ–¥–∫–æ–µ –Ω–µ–±–µ—Å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏–Ω–µ—Å—ë—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é –≤ –≤–∞—à–∏ –ø–ª–∞–Ω—ã. `;
    }
  }

  // === –ü–ï–†–ï–•–û–î –°–û–õ–ù–¶–ê –í –î–ï–í–£ (22-23 –∞–≤–≥—É—Å—Ç–∞) ===
  if (todayFactors.virgo_season_start) {
    if (sign === '–î–µ–≤–∞') {
      horoscope += `üéâ –í–∞—à —Å–µ–∑–æ–Ω —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—Å—è! –°–æ–ª–Ω—Ü–µ –≤ –î–µ–≤–µ –¥–æ 22 —Å–µ–Ω—Ç—è–±—Ä—è –¥–∞—Ä–∏—Ç –≤–∞–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∏–ª—É –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å. `;
    } else if (currentSign.element === 'earth') {
      horoscope += `–°–æ–ª–Ω—Ü–µ –≤ –î–µ–≤–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ—Ö –∑–µ–º–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤. –í—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–ª –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π. `;
    } else {
      horoscope += `–°–æ–ª–Ω—Ü–µ –≤–æ—à–ª–æ –≤ –î–µ–≤—É - –ø–µ—Ä–∏–æ–¥ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤. `;
    }
  }

  // === –í–ï–ù–ï–†–ê –í –í–ï–°–ê–• ===
  if (todayFactors.venus_in_libra && (currentSign.ruler === 'venus' || sign === '–í–µ—Å—ã')) {
    horoscope += `–í–µ–Ω–µ—Ä–∞ –≤ –í–µ—Å–∞—Ö –æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–º! –õ—é–±–æ–≤—å, –∫—Ä–∞—Å–æ—Ç–∞ –∏ –≥–∞—Ä–º–æ–Ω–∏—è —Ä–∞—Å—Ü–≤–µ—Ç–∞—é—Ç –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏. `;
  }

  // === –ú–ï–†–ö–£–†–ò–ô –î–ò–†–ï–ö–¢–ù–´–ô ===
  if (todayFactors.mercury_direct && currentSign.ruler === 'mercury') {
    horoscope += `–ú–µ—Ä–∫—É—Ä–∏–π –≤ –ø—Ä—è–º–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∞—à—É –ø–ª–∞–Ω–µ—Ç—É-–ø–æ–∫—Ä–æ–≤–∏—Ç–µ–ª—è! –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è, –æ–±—É—á–µ–Ω–∏–µ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏–¥—É—Ç –∫–∞–∫ –ø–æ –º–∞—Å–ª—É. `;
  }

  // === –ú–ê–†–° –í –†–ê–ö–ï ===
  if (todayFactors.mars_in_cancer) {
    if (sign === '–†–∞–∫') {
      horoscope += `–ú–∞—Ä—Å –≤ –≤–∞—à–µ–º –∑–Ω–∞–∫–µ –≤–µ—Å—å –∞–≤–≥—É—Å—Ç! –≠—Ç–æ –ø—Ä–∏–¥–∞—ë—Ç –Ω–µ–æ–±—ã—á–Ω—É—é —Å–º–µ–ª–æ—Å—Ç—å –∏ —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è –∑–∞—â–∏—Ç—ã –±–ª–∏–∑–∫–∏—Ö. `;
    } else if (currentSign.element === 'water') {
      horoscope += `–ú–∞—Ä—Å –≤ –≤–æ–¥–Ω–æ–º –∑–Ω–∞–∫–µ –†–∞–∫–∞ –∞–∫—Ç–∏–≤–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à—É —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é. `;
    }
  }

  // === –í–†–ï–ú–Ø –°–£–¢–û–ö ===
  if (todayFactors.is_morning) {
    if (currentSign.element === 'fire') {
      horoscope += `–£—Ç—Ä–µ–Ω–Ω–∏–µ —á–∞—Å—ã –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –≤–∞—à–µ–π –æ–≥–Ω–µ–Ω–Ω–æ–π –Ω–∞—Ç—É—Ä–µ. –ù–∞—á–∏–Ω–∞–π—Ç–µ –¥–µ–Ω—å —Å –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ª! `;
    } else {
      horoscope += `–£—Ç—Ä–æ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Å–≤–µ–∂–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. `;
    }
  } else if (todayFactors.is_evening) {
    if (currentSign.element === 'water') {
      horoscope += `–í–µ—á–µ—Ä–Ω–µ–µ –≤—Ä–µ–º—è —É—Å–∏–ª–∏–≤–∞–µ—Ç –≤–∞—à—É –∏–Ω—Ç—É–∏—Ü–∏—é –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. `;
    } else {
      horoscope += `–í–µ—á–µ—Ä –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–µ–Ω –¥–ª—è –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤ –¥–Ω—è. `;
    }
  }

  // === –î–ï–ù–¨ –ù–ï–î–ï–õ–ò (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫) ===
  const weeklyAdvice = {
    1: { // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
      energy: '–õ—É–Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–æ–º',
      general: '–î–µ–Ω—å –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–¥–µ–ª–∏ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
      fire: '–ù–∞–ø—Ä–∞–≤—å—Ç–µ —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫—É —Ü–µ–ª–µ–π –Ω–∞ –Ω–µ–¥–µ–ª—é',
      earth: '–°–æ—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ',
      air: '–ü–æ–æ–±—â–∞–π—Ç–µ—Å—å —Å –∫–æ–ª–ª–µ–≥–∞–º–∏ –∏ –æ–±–º–µ–Ω—è–π—Ç–µ—Å—å –∏–¥–µ—è–º–∏', 
      water: '–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ –∏–Ω—Ç—É–∏—Ü–∏–∏ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏'
    },
    2: { // –í—Ç–æ—Ä–Ω–∏–∫ - –¥–µ–Ω—å –ú–∞—Ä—Å–∞
      energy: '–ú–∞—Ä—Å –Ω–∞–ø–æ–ª–Ω—è–µ—Ç –¥–µ–Ω—å —Å–∏–ª–æ–π',
      general: '–í—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∏ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π',
      fire: '–í–∞—à –¥–µ–Ω—å! –î–µ–π—Å—Ç–≤—É–π—Ç–µ —Å–º–µ–ª–æ –∏ —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ',
      earth: '–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ —É–ø–æ—Ä—Å—Ç–≤–æ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π',
      air: '–ê–∫—Ç–∏–≤–Ω–æ –ø—Ä–æ–¥–≤–∏–≥–∞–π—Ç–µ —Å–≤–æ–∏ –∏–¥–µ–∏',
      water: '–ó–∞—â–∏—â–∞–π—Ç–µ —Å–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ –±–ª–∏–∑–∫–∏—Ö'
    }
    // ... –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–Ω–∏
  };

  const todayAdvice = weeklyAdvice[dayOfWeek];
  if (todayAdvice) {
    horoscope += `${todayAdvice.energy}. ${todayAdvice[currentSign.element] || todayAdvice.general}. `;
  }

  // === –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ===
  if (todayFactors.high_energy_time) {
    horoscope += `–°–µ–π—á–∞—Å (${hour}:${minutes.toString().padStart(2, '0')}) - –≤—Ä–µ–º—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏! `;
  }

  // === –ó–ê–í–ï–†–®–ï–ù–ò–ï –° –ú–£–î–†–û–°–¢–¨–Æ –ì–ù–û–ú–û–í ===
  const wisdomPhrases = [
    '–ü–æ–º–Ω–∏—Ç–µ: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–∏–Ω–æ—Å–∏—Ç –Ω–æ–≤—ã–µ –∑–≤—ë–∑–¥–Ω—ã–µ –¥–∞—Ä—ã!',
    '–ú—É–¥—Ä–æ—Å—Ç—å –≥–Ω–æ–º–æ–≤: —Å–ª—É—à–∞–π—Ç–µ –Ω–µ–±–æ, –Ω–æ —Å—Ç–æ–π—Ç–µ –Ω–∞ –∑–µ–º–ª–µ.',
    '–ó–≤—ë–∑–¥—ã –Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç, –Ω–æ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –≤—ã.',
    '–í –∫–∞–∂–¥–æ–º –º–æ–º–µ–Ω—Ç–µ –µ—Å—Ç—å –º–∞–≥–∏—è - –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –µ—ë –∑–∞–º–µ—Ç–∏—Ç—å.',
    '–ì–Ω–æ–º—ã –∑–Ω–∞—é—Ç: –ª—É—á—à–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø - —ç—Ç–æ –≤–∞—à–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è!'
  ];

  horoscope += getRandomItem(wisdomPhrases);

  return horoscope;
}

// –û–±–Ω–æ–≤–ª—è–µ–º endpoint –≥–æ—Ä–æ—Å–∫–æ–ø–∞ —Å –µ—â—ë –±–æ–ª—å—à–µ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å—é
app.get('/api/horoscope', (req, res) => {
  try {
    const { sign } = req.query;
    
    if (!sign) {
      return res.status(400).json({
        error: '–ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω',
        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞'
      });
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –°–£–ü–ï–† –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø
    const actualText = generateActualHoroscope(sign);
    
    const now = new Date();
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    const extras = {
      // –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å–æ–±—ã—Ç–∏–π
      mood: now.getDate() === 26 ? '–ú–∞–≥–Ω–µ—Ç–∏—á–µ—Å–∫–æ–µ' : // –õ—É–Ω–∞+–ú–∞—Ä—Å
            now.getHours() >= 6 && now.getHours() <= 10 ? '–£—Ç—Ä–µ–Ω–Ω–µ–µ' :
            now.getHours() >= 18 && now.getHours() <= 22 ? '–í–µ—á–µ—Ä–Ω–µ–µ' :
            '–ì–∞—Ä–º–æ–Ω–∏—á–Ω–æ–µ',
      
      // –°—á–∞—Å—Ç–ª–∏–≤—ã–µ —á–∏—Å–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏  
      luckyNumber: (now.getDate() + now.getHours()) % 99 + 1,
      
      // –¶–≤–µ—Ç–∞ –ø–æ —Ç–µ–∫—É—â–∏–º –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–º –≤–ª–∏—è–Ω–∏—è–º
      color: now.getDate() === 26 ? '#DC143C' : // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –ú–∞—Ä—Å–∞
             now.getMonth() === 7 && now.getDate() >= 22 ? '#8B4513' : // –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π –¥–ª—è –î–µ–≤—ã
             '#4169E1', // –°–∏–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      
      // –ê–∫—Ç—É–∞–ª—å–Ω–æ–µ –∞—Å—Ç—Ä–æ—Å–æ–±—ã—Ç–∏–µ
      astro_event: now.getDate() === 26 ? 'üåô‚ù§Ô∏è –õ—É–Ω–∞ —Ä—è–¥–æ–º —Å –ú–∞—Ä—Å–æ–º' :
                   now.getDate() >= 22 && now.getDate() <= 30 ? '‚ôç –°–æ–ª–Ω—Ü–µ –≤ –î–µ–≤–µ' :
                   null,
      
      // –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      generated_at: now.toLocaleString('ru-RU', {
        timeZone: 'Asia/Almaty',
        year: 'numeric',
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }),
      
      // –°–ª–µ–¥—É—é—â–µ–µ –≤–∞–∂–Ω–æ–µ –∞—Å—Ç—Ä–æ—Å–æ–±—ã—Ç–∏–µ
      next_event: '–ù–æ–≤–æ–ª—É–Ω–∏–µ –≤ –î–µ–≤–µ


// –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ê–ö–¢–£–ê–õ–¨–ù–´–• –∞—Å—Ç—Ä–æ—Å–æ–±—ã—Ç–∏–π
app.get('/api/astro-events', (req, res) => {
  try {
    // –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∞–≤–≥—É—Å—Ç 2025
    const actualEvents = [
      {
        date: '10 –∞–≤–≥',
        title: '–ü–∞—Ä–∞–¥ 6 –ø–ª–∞–Ω–µ—Ç',
        shortText: '–ú–µ—Ä–∫—É—Ä–∏–π, –í–µ–Ω–µ—Ä–∞, –Æ–ø–∏—Ç–µ—Ä, –°–∞—Ç—É—Ä–Ω, –£—Ä–∞–Ω –∏ –ù–µ–ø—Ç—É–Ω –≤—ã—Å—Ç—Ä–æ—è—Ç—Å—è –Ω–∞ –ø—Ä–µ–¥—Ä–∞—Å—Å–≤–µ—Ç–Ω–æ–º –Ω–µ–±–µ. 4 –ø–ª–∞–Ω–µ—Ç—ã –≤–∏–¥–Ω—ã –Ω–µ–≤–æ–æ—Ä—É–∂–µ–Ω–Ω—ã–º –≥–ª–∞–∑–æ–º!',
        type: 'planet_alignment',
        fullDate: '2025-08-10T04:00:00Z',
        visibility: '–í–∏–¥–Ω–æ –≤ –°–µ–≤–µ—Ä–Ω–æ–º –ø–æ–ª—É—à–∞—Ä–∏–∏ –ø–µ—Ä–µ–¥ —Ä–∞—Å—Å–≤–µ—Ç–æ–º'
      },
      {
        date: '9 –∞–≤–≥',
        title: '–û—Å–µ—Ç—Ä–æ–≤–æ–µ –ø–æ–ª–Ω–æ–ª—É–Ω–∏–µ –≤ –í–æ–¥–æ–ª–µ–µ',
        shortText: '–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ –≤ –∑–Ω–∞–∫–µ –í–æ–¥–æ–ª–µ—è. –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ª –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏–π.',
        type: 'full_moon',
        fullDate: '2025-08-09T18:55:00Z',
        visibility: '–í–∏–¥–Ω–æ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É'
      },
      {
        date: '11-12 –∞–≤–≥',
        title: '–ü–∏–∫ –º–µ—Ç–µ–æ—Ä–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –ü–µ—Ä—Å–µ–∏–¥—ã',
        shortText: '–î–æ 100 –º–µ—Ç–µ–æ—Ä–æ–≤ –≤ —á–∞—Å! –û–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –∑—Ä–µ–ª–∏—â–Ω—ã—Ö –∑–≤–µ–∑–¥–æ–ø–∞–¥–æ–≤ –≥–æ–¥–∞. –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è - –ø—Ä–µ–¥—Ä–∞—Å—Å–≤–µ—Ç–Ω—ã–µ —á–∞—Å—ã.',
        type: 'meteor_shower',
        fullDate: '2025-08-12T03:00:00Z',
        visibility: '–õ—É—á—à–µ –≤—Å–µ–≥–æ –≤ –°–µ–≤–µ—Ä–Ω–æ–º –ø–æ–ª—É—à–∞—Ä–∏–∏'
      },
      {
        date: '12 –∞–≤–≥',
        title: '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –í–µ–Ω–µ—Ä—ã –∏ –Æ–ø–∏—Ç–µ—Ä–∞',
        shortText: '–î–≤–∞ —Å–∞–º—ã—Ö —è—Ä–∫–∏—Ö –æ–±—ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –õ—É–Ω—ã —Å–±–ª–∏–∑—è—Ç—Å—è –≤ —Å–æ–∑–≤–µ–∑–¥–∏–∏ –ë–ª–∏–∑–Ω–µ—Ü–æ–≤. –ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –∫—Ä–∞—Å–∏–≤–æ–µ –∑—Ä–µ–ª–∏—â–µ!',
        type: 'planet_conjunction',
        fullDate: '2025-08-12T05:30:00Z',
        visibility: '–í–æ—Å—Ç–æ—á–Ω—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø–µ—Ä–µ–¥ —Ä–∞—Å—Å–≤–µ—Ç–æ–º'
      },
      {
        date: '19 –∞–≤–≥',
        title: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–ª–æ–Ω–≥–∞—Ü–∏—è –ú–µ—Ä–∫—É—Ä–∏—è',
        shortText: '–ú–µ—Ä–∫—É—Ä–∏–π –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É–≥–ª–æ–≤–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –æ—Ç –°–æ–ª–Ω—Ü–∞ (18¬∞). –ù–∞–∏–ª—É—á—à–∏–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π –ø–ª–∞–Ω–µ—Ç—ã.',
        type: 'planet_transit',
        fullDate: '2025-08-19T06:00:00Z',
        visibility: '–£—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–µ–±–æ, –¥–æ 1.5 —á–∞—Å–æ–≤ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è'
      },
      {
        date: '19-21 –∞–≤–≥',
        title: '–õ—É–Ω–∞ —Ç–∞–Ω—Ü—É–µ—Ç —Å –ø–ª–∞–Ω–µ—Ç–∞–º–∏',
        shortText: '–ú–æ–ª–æ–¥–∞—è –õ—É–Ω–∞ –ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ –ø—Ä–æ–π–¥–µ—Ç —Ä—è–¥–æ–º —Å –Æ–ø–∏—Ç–µ—Ä–æ–º (20 –∞–≤–≥), –í–µ–Ω–µ—Ä–æ–π (20 –∞–≤–≥) –∏ –ú–µ—Ä–∫—É—Ä–∏–µ–º (21 –∞–≤–≥).',
        type: 'moon_planets',
        fullDate: '2025-08-20T03:00:00Z',
        visibility: '–í–æ—Å—Ç–æ—á–Ω—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø–µ—Ä–µ–¥ —Ä–∞—Å—Å–≤–µ—Ç–æ–º'
      },
      {
        date: '23 –∞–≤–≥',
        title: '–ù–æ–≤–æ–ª—É–Ω–∏–µ –≤ –î–µ–≤–µ',
        shortText: '–ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π. –¢–µ–º–Ω–æ–µ –Ω–µ–±–æ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∑–≤–µ–∑–¥.',
        type: 'new_moon',
        fullDate: '2025-08-23T09:06:00Z',
        visibility: '–õ—É–Ω–∞ –Ω–µ –≤–∏–¥–Ω–∞, —Ç–µ–º–Ω–æ–µ –Ω–µ–±–æ'
      },
      {
        date: '26 –∞–≤–≥',
        title: '–õ—É–Ω–∞ —Ä—è–¥–æ–º —Å –ú–∞—Ä—Å–æ–º',
        shortText: '–°–±–ª–∏–∂–µ–Ω–∏–µ —Ä–∞—Å—Ç—É—â–µ–π –õ—É–Ω—ã —Å –∫—Ä–∞—Å–Ω–æ–π –ø–ª–∞–Ω–µ—Ç–æ–π –ú–∞—Ä—Å –≤ —Å–æ–∑–≤–µ–∑–¥–∏–∏ –î–µ–≤—ã. –ö—Ä–∞—Å–∏–≤–∞—è –ø–∞—Ä–∞ –Ω–∞ —é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω–æ–º –Ω–µ–±–µ.',
        type: 'moon_mars',
        fullDate: '2025-08-26T22:00:00Z',
        visibility: '–Æ–≥–æ-–≤–æ—Å—Ç–æ—á–Ω–æ–µ –Ω–µ–±–æ –ø–æ—Å–ª–µ –∑–∞–∫–∞—Ç–∞'
      }
    ];

    res.json({
      events: actualEvents,
      source: 'astronomy_data',
      generated_at: new Date().toISOString(),
      note: '–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∞–≤–≥—É—Å—Ç 2025 –≥–æ–¥–∞',
      total_events: actualEvents.length
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ /api/astro-events:', error);
    res.status(500).json({ 
      error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞—Å—Ç—Ä–æ—Å–æ–±—ã—Ç–∏—è',
      message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—É –¥–Ω—è
app.post('/api/day-card', (req, res) => {
  try {
    const card = getRandomItem(dayCards);
    
    res.json({
      ...card,
      date: new Date().toISOString(),
      type: 'day-card',
      source: 'internet',
      wisdom: '–ú—É–¥—Ä–æ—Å—Ç—å –¥—Ä–µ–≤–Ω–∏—Ö –≥–Ω–æ–º–æ–≤ –≤—Å–µ–≥–¥–∞ —Å –≤–∞–º–∏! üßô‚Äç‚ôÇÔ∏è'
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ /api/day-card:', error);
    res.status(500).json({ 
      error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç—É –¥–Ω—è',
      message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç –¥–Ω—è
app.get('/api/advice', (req, res) => {
  try {
    const advice = getRandomItem(adviceTexts);
    
    res.json({
      text: advice + ' üßô‚Äç‚ôÇÔ∏è',
      date: new Date().toISOString(),
      type: 'advice',
      source: 'internet',
      category: 'daily-wisdom'
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ /api/advice:', error);
    res.status(500).json({ 
      error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç',
      message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    });
  }
});

// –õ—É–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
app.get('/api/moon', (req, res) => {
  try {
    const today = new Date();
    const dateString = today.toISOString().split('T')[0];
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
    
    const phaseIndex = dayOfYear % moonPhases.length;
    const currentPhase = moonPhases[phaseIndex];
    
    const calendar = [];
    for (let i = 0; i < 7; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      const dayNum = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
      const phaseIdx = dayNum % moonPhases.length;
      
      calendar.push({
        date: date.toISOString(),
        displayDate: date.toLocaleDateString('ru-RU', { 
          weekday: 'short', 
          day: 'numeric', 
          month: 'short' 
        }),
        ...moonPhases[phaseIdx],
        age: (dayNum % 29) + 1
      });
    }
    
    const adviceMap = {
      '–ù–æ–≤–æ–ª—É–Ω–∏–µ': {
        title: '–í—Ä–µ–º—è –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π',
        text: '–ì–Ω–æ–º –ú–µ—á—Ç–∞—Ç–µ–ª—å —Å–æ–≤–µ—Ç—É–µ—Ç: —Å–µ–π—á–∞—Å –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –Ω–æ–≤—ã—Ö –∏–¥–µ–π. –õ—É–Ω–∞ —Å–∫—Ä—ã—Ç–∞, –Ω–æ —ç–Ω–µ—Ä–≥–∏—è —Ä–æ—Å—Ç–∞ —É–∂–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è.',
        activities: ['–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', '–ú–µ–¥–∏—Ç–∞—Ü–∏—è', '–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–µ–π'],
        avoid: ['–í–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è', '–ö—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏']
      },
      '–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ': {
        title: '–ü–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–π',
        text: '–ì–Ω–æ–º –ú–∞–≥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç: –º–∞–∫—Å–∏–º—É–º –ª—É–Ω–Ω–æ–π —Å–∏–ª—ã! –ó–∞–≤–µ—Ä—à–∞–π—Ç–µ –¥–µ–ª–∞, –Ω–æ –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å —ç–º–æ—Ü–∏—è–º–∏.',
        activities: ['–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤', '–ü—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ', '–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å'],
        avoid: ['–ò–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å', '–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã', '–ê–ª–∫–æ–≥–æ–ª—å']
      }
    };
    
    const advice = adviceMap[currentPhase.phase] || adviceMap['–ù–æ–≤–æ–ª—É–Ω–∏–µ'];
    
    const nextFullMoonDays = 15 - (dayOfYear % 15);
    const nextNewMoonDays = 30 - (dayOfYear % 30);
    
    const nextFullMoon = new Date(today);
    nextFullMoon.setDate(today.getDate() + nextFullMoonDays);
    
    const nextNewMoon = new Date(today);
    nextNewMoon.setDate(today.getDate() + nextNewMoonDays);
    
    res.json({
      current: {
        ...currentPhase,
        age: (dayOfYear % 29) + 1,
        date: today.toISOString(),
        advice
      },
      calendar,
      moonrise: '06:45',
      moonset: '19:30',
      nextFullMoon: nextFullMoon.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }),
      nextNewMoon: nextNewMoon.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' }),
      source: 'internet',
      cached_until: `${dateString}T23:59:59.999Z`
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ /api/moon:', error);
    res.status(500).json({ 
      error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª—É–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
      message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    });
  }
});

// –ù—É–º–µ—Ä–æ–ª–æ–≥–∏—è
app.post('/api/numerology', (req, res) => {
  try {
    const { birthDate } = req.body;
    
    if (!birthDate) {
      return res.status(400).json({ 
        error: '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞',
        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD'
      });
    }
    
    const lifeNumber = calculateLifeNumber(birthDate);
    const numerologyData = {
      1: { character: '–õ–∏–¥–µ—Ä –∏ –ø–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥–µ—Ü. –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–Ω—ã–π.', destiny: '–°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–µ –∏ –≤–µ—Å—Ç–∏ –ª—é–¥–µ–π –∑–∞ —Å–æ–±–æ–π.' },
      2: { character: '–ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü –∏ –¥–∏–ø–ª–æ–º–∞—Ç. –ì–∞—Ä–º–æ–Ω–∏—è - –≤–∞—à–∞ —Å—É–ø–µ—Ä—Å–∏–ª–∞.', destiny: '–û–±—ä–µ–¥–∏–Ω—è—Ç—å –ª—é–¥–µ–π –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å.' },
      3: { character: '–¢–≤–æ—Ä–µ—Ü –∏ –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç–µ–ª—å. –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –∫—Ä–æ–≤–∏.', destiny: '–ù–µ—Å—Ç–∏ –∫—Ä–∞—Å–æ—Ç—É –∏ —Ä–∞–¥–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∏—Å–∫—É—Å—Å—Ç–≤–æ.' },
      4: { character: '–°—Ç—Ä–æ–∏—Ç–µ–ª—å –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä. –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å - –æ—Å–Ω–æ–≤–∞.', destiny: '–°–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ—á–Ω—ã–µ –æ—Å–Ω–æ–≤—ã –¥–ª—è –±—É–¥—É—â–µ–≥–æ.' },
      5: { character: '–ò—Å–∫–∞—Ç–µ–ª—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π. –ü–µ—Ä–µ–º–µ–Ω—ã - —Å—Ç–∏—Ö–∏—è.', destiny: '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –º–∏—Ä –∏ –¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º.' },
      6: { character: '–ó–∞–±–æ—Ç–ª–∏–≤—ã–π –∑–∞—â–∏—Ç–Ω–∏–∫ —Å–µ–º—å–∏. –õ—é–±–æ–≤—å - —Å–∏–ª–∞.', destiny: '–ù–µ—Å—Ç–∏ –∑–∞–±–æ—Ç—É –∏ –∏—Å—Ü–µ–ª–µ–Ω–∏–µ –ª—é–¥—è–º.' },
      7: { character: '–ú—É–¥—Ä–µ—Ü –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å –∏—Å—Ç–∏–Ω—ã. –î—É—Ö–æ–≤–Ω–æ—Å—Ç—å.', destiny: '–û—Ç–∫—Ä—ã–≤–∞—Ç—å —Ç–∞–π–Ω—ã –∏ –¥–µ–ª–∏—Ç—å—Å—è –º—É–¥—Ä–æ—Å—Ç—å—é.' },
      8: { character: '–ú–∞—Ç–µ—Ä–∏–∞–ª–∏—Å—Ç –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä. –£—Å–ø–µ—Ö —á–µ—Ä–µ–∑ —Ç—Ä—É–¥.', destiny: '–î–æ—Å—Ç–∏—á—å –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è –∏ –ø–æ–º–æ—á—å –¥—Ä—É–≥–∏–º.' },
      9: { character: '–ì—É–º–∞–Ω–∏—Å—Ç –∏ –∞–ª—å—Ç—Ä—É–∏—Å—Ç. –°–ª—É–∂–µ–Ω–∏–µ –ª—é–¥—è–º.', destiny: '–ù–µ—Å—Ç–∏ —Å–≤–µ—Ç –∑–Ω–∞–Ω–∏–π –≤—Å–µ–º—É —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤—É.' }
    };
    
    const data = numerologyData[lifeNumber];
    
    res.json({
      number: lifeNumber,
      ...data,
      birthDate,
      source: 'internet',
      calculation: '–ì–Ω–æ–º—å—è –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—è –ø–æ –¥—Ä–µ–≤–Ω–∏–º –º–µ—Ç–æ–¥–∞–º'
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ /api/numerology:', error);
    res.status(500).json({ 
      error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—é',
      message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    });
  }
});

// –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
app.post('/api/compatibility', (req, res) => {
  try {
    const { sign1, sign2 } = req.body;
    
    if (!sign1 || !sign2) {
      return res.status(400).json({ 
        error: '–û–±–∞ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã',
        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –æ–±–∞ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏'
      });
    }
    
    const compatibilityMatrix = {
      '–û–≤–µ–Ω': { '–õ–µ–≤': 95, '–°—Ç—Ä–µ–ª–µ—Ü': 92, '–ë–ª–∏–∑–Ω–µ—Ü—ã': 88, '–í–æ–¥–æ–ª–µ–π': 85 },
      '–¢–µ–ª–µ—Ü': { '–î–µ–≤–∞': 94, '–ö–æ–∑–µ—Ä–æ–≥': 91, '–†–∞–∫': 87, '–†—ã–±—ã': 84 },
      '–ë–ª–∏–∑–Ω–µ—Ü—ã': { '–í–µ—Å—ã': 93, '–í–æ–¥–æ–ª–µ–π': 90, '–û–≤–µ–Ω': 88, '–õ–µ–≤': 85 },
      '–†–∞–∫': { '–°–∫–æ—Ä–ø–∏–æ–Ω': 96, '–†—ã–±—ã': 93, '–¢–µ–ª–µ—Ü': 87, '–î–µ–≤–∞': 84 },
      '–õ–µ–≤': { '–û–≤–µ–Ω': 95, '–°—Ç—Ä–µ–ª–µ—Ü': 92, '–ë–ª–∏–∑–Ω–µ—Ü—ã': 85, '–í–µ—Å—ã': 82 },
      '–î–µ–≤–∞': { '–¢–µ–ª–µ—Ü': 94, '–ö–æ–∑–µ—Ä–æ–≥': 91, '–†–∞–∫': 84, '–°–∫–æ—Ä–ø–∏–æ–Ω': 81 },
      '–í–µ—Å—ã': { '–ë–ª–∏–∑–Ω–µ—Ü—ã': 93, '–í–æ–¥–æ–ª–µ–π': 90, '–õ–µ–≤': 82, '–°—Ç—Ä–µ–ª–µ—Ü': 79 },
      '–°–∫–æ—Ä–ø–∏–æ–Ω': { '–†–∞–∫': 96, '–†—ã–±—ã': 93, '–î–µ–≤–∞': 81, '–ö–æ–∑–µ—Ä–æ–≥': 78 },
      '–°—Ç—Ä–µ–ª–µ—Ü': { '–û–≤–µ–Ω': 92, '–õ–µ–≤': 92, '–í–µ—Å—ã': 79, '–í–æ–¥–æ–ª–µ–π': 76 },
      '–ö–æ–∑–µ—Ä–æ–≥': { '–î–µ–≤–∞': 91, '–¢–µ–ª–µ—Ü': 91, '–°–∫–æ—Ä–ø–∏–æ–Ω': 78, '–†—ã–±—ã': 75 },
      '–í–æ–¥–æ–ª–µ–π': { '–ë–ª–∏–∑–Ω–µ—Ü—ã': 90, '–í–µ—Å—ã': 90, '–û–≤–µ–Ω': 85, '–°—Ç—Ä–µ–ª–µ—Ü': 76 },
      '–†—ã–±—ã': { '–°–∫–æ—Ä–ø–∏–æ–Ω': 93, '–†–∞–∫': 93, '–¢–µ–ª–µ—Ü': 84, '–ö–æ–∑–µ—Ä–æ–≥': 75 }
    };
    
    let percentage = compatibilityMatrix[sign1]?.[sign2] || 
                    compatibilityMatrix[sign2]?.[sign1] || 
                    (Math.floor(Math.random() * 40) + 55);
    
    let emoji = percentage >= 90 ? 'üíñ' : percentage >= 80 ? 'üíï' : percentage >= 70 ? '‚ù§Ô∏è' : 'üíõ';
    
    let description;
    if (percentage >= 90) description = '–ò–¥–µ–∞–ª—å–Ω–∞—è –ø–∞—Ä–∞! –ó–≤–µ–∑–¥—ã –±–ª–∞–≥–æ—Å–ª–æ–≤–ª—è—é—Ç –≤–∞—à —Å–æ—é–∑ –≥–∞—Ä–º–æ–Ω–∏–µ–π –∏ –≤–∑–∞–∏–º–æ–ø–æ–Ω–∏–º–∞–Ω–∏–µ–º.';
    else if (percentage >= 80) description = '–û—Ç–ª–∏—á–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å! –í—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –¥–æ–ø–æ–ª–Ω—è–µ—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –≤–æ –≤—Å–µ—Ö —Å—Ñ–µ—Ä–∞—Ö –∂–∏–∑–Ω–∏.';
    else if (percentage >= 70) description = '–•–æ—Ä–æ—à–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è! –ù–µ–º–Ω–æ–≥–æ —É—Å–∏–ª–∏–π - –∏ –±—É–¥–µ—Ç–µ –Ω–µ—Ä–∞–∑–ª—É—á–Ω—ã –∫–∞–∫ –≥–Ω–æ–º—ã –≤ –≥–æ—Ä–∞—Ö.';
    else description = '–°—Ä–µ–¥–Ω—è—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å. –†–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏ –≤–º–µ—Å—Ç–µ - –≥–Ω–æ–º—å—è –º—É–¥—Ä–æ—Å—Ç—å –ø–æ–º–æ–∂–µ—Ç!';
    
    res.json({
      sign1,
      sign2,
      percentage,
      emoji,
      description,
      source: 'internet',
      advice: '–ü–æ–º–Ω–∏—Ç–µ: –ª—é–±–æ–≤—å –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞–µ—Ç –ª—é–±—ã–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–ª–∏—á–∏—è! üí´'
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ /api/compatibility:', error);
    res.status(500).json({ 
      error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å',
      message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    });
  }
});

// –°—Ç–∞—Ç—É—Å –ú–µ—Ä–∫—É—Ä–∏—è
app.get('/api/mercury', (req, res) => {
  try {
    const now = new Date();
    const retrogradeePeriods2025 = [
      { start: new Date('2025-03-15'), end: new Date('2025-04-07') },
      { start: new Date('2025-07-18'), end: new Date('2025-08-11') },
      { start: new Date('2025-11-09'), end: new Date('2025-11-29') }
    ];
    
    const isRetrograde = retrogradeePeriods2025.some(period => 
      now >= period.start && now <= period.end
    );
    
    const nextPeriod = retrogradeePeriods2025.find(period => now < period.start);
    
    res.json({
      isRetrograde,
      period: isRetrograde 
        ? `–†–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–π –¥–æ ${retrogradeePeriods2025.find(p => now >= p.start && now <= p.end)?.end.toLocaleDateString('ru-RU')}`
        : nextPeriod 
          ? `–î–∏—Ä–µ–∫—Ç–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –¥–æ ${nextPeriod.start.toLocaleDateString('ru-RU')}`
          : '–î–∏—Ä–µ–∫—Ç–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ',
      description: isRetrograde 
        ? '–ú–µ—Ä–∫—É—Ä–∏–π —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–π. –í—Ä–µ–º—è –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–∏—è –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ª. –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã —Å —Ç–µ—Ö–Ω–∏–∫–æ–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏. –û—Ç–ª–∏—á–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–∞–±–æ—Ç—ã.'
        : '–ú–µ—Ä–∫—É—Ä–∏–π –≤ –¥–∏—Ä–µ–∫—Ç–Ω–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏. –û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π, –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤, –ø–æ–µ–∑–¥–æ–∫ –∏ –æ–±—É—á–µ–Ω–∏—è. –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è —Ç–µ—á–µ—Ç –ª–µ–≥–∫–æ –∏ —è—Å–Ω–æ.',
      date: new Date().toISOString(),
      source: 'internet',
      advice: isRetrograde 
        ? '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–µ–ª –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–∞–±–æ—Ç—ã. üîÑ'
        : '–í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å! –ó–∞–∫–ª—é—á–∞–π—Ç–µ —Å–¥–µ–ª–∫–∏ –∏ –Ω–∞—á–∏–Ω–∞–π—Ç–µ –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã. ‚ö°'
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ /api/mercury:', error);
    res.status(500).json({ 
      error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ú–µ—Ä–∫—É—Ä–∏—è',
      message: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    });
  }
});

// 404 –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è API
app.use('/api/*', (req, res) => {
  res.status(404).json({
    error: '–≠–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω',
    message: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL –∏ –º–µ—Ç–æ–¥–∞ –∑–∞–ø—Ä–æ—Å–∞',
    availableEndpoints: [
      'GET /api/horoscope?sign=<–∑–Ω–∞–∫>',
      'POST /api/day-card',
      'GET /api/advice', 
      'POST /api/numerology',
      'POST /api/compatibility',
      'GET /api/moon',
      'GET /api/mercury',
      'GET /api/astro-events'
    ]
  });
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
app.use((err, req, res, next) => {
  console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
  res.status(500).json({
    error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
    message: '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
    timestamp: new Date().toISOString()
  });
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
app.listen(PORT, () => {
  console.log(`üßô‚Äç‚ôÇÔ∏è –ì–Ω–æ–º–∏–π –ì–æ—Ä–æ—Å–∫–æ–ø API –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
  console.log(`üåê –†–µ–∂–∏–º: ${process.env.NODE_ENV || 'development'}`);
  console.log(`üìÖ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: ${new Date().toLocaleString('ru-RU')}`);
  console.log(`üîó –î–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:${PORT}`);
  console.log('‚ú® –û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –ê–ö–¢–£–ê–õ–¨–ù–´–ï –≥–æ—Ä–æ—Å–∫–æ–ø—ã –∏ –∞—Å—Ç—Ä–æ—Å–æ–±—ã—Ç–∏—è –∞–≤–≥—É—Å—Ç 2025!');
});

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGINT. –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞...');
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM. –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞...');
  process.exit(0);
});

